on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
    - name: Thiáº¿t láº­p SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

    - name: Kiá»ƒm tra biáº¿n SSH_HOST
      run: |
        echo "ğŸ” SSH_HOST = ${{ secrets.SSH_HOST }}"
        echo "ğŸ” SSH_USER = ${{ secrets.SSH_USER }}"

    - name: Káº¿t ná»‘i SSH vÃ  deploy
      run: |
        echo "ğŸš€ Báº¯t Ä‘áº§u káº¿t ná»‘i SSH Ä‘áº¿n VPS..."
        ssh -o StrictHostKeyChecking=no -T ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << EOF
          echo "âœ… Káº¿t ná»‘i SSH thÃ nh cÃ´ng!"

          echo "ğŸ“‚ Di chuyá»ƒn vÃ o thÆ° má»¥c: ${{ secrets.WORK_DIR }}"
          cd ${{ secrets.WORK_DIR }} || { echo "âŒ KhÃ´ng tÃ¬m tháº¥y thÆ° má»¥c!"; exit 1; }

          echo "ğŸ”„ Chuyá»ƒn branch: ${{ secrets.MAIN_BRANCH }}"
          git checkout ${{ secrets.MAIN_BRANCH }} || { echo "âŒ Checkout lá»—i!"; exit 1; }

          echo "â¬‡ï¸  Pull code tá»« Git"
          git pull || { echo "âŒ Pull lá»—i!"; exit 1; }

          echo "ğŸš€ Cháº¡y script deploy.sh"
          chmod +x ./deploy.sh
          ./deploy.sh || { echo "âŒ Lá»—i khi cháº¡y deploy.sh!"; exit 1; }

          echo "ğŸ‰ Deploy thÃ nh cÃ´ng!"
        EOF
