name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ” In ra biáº¿n Ä‘á»ƒ debug
      run: |
        echo "SSH_HOST = '${{ secrets.SSH_HOST }}'"
        echo "SSH_USER = '${{ secrets.SSH_USER }}'"
        echo "MAIN_BRANCH = '${{ secrets.MAIN_BRANCH }}'"
        echo "WORK_DIR = '${{ secrets.WORK_DIR }}'"
        if [ -z "${{ secrets.SSH_HOST }}" ]; then
          echo "âŒ Lá»—i: SSH_HOST rá»—ng hoáº·c khÃ´ng tá»“n táº¡i!"
          exit 1
        else
          echo "âœ… SSH_HOST Ä‘Ã£ cÃ³ giÃ¡ trá»‹."
        fi

    - name: ğŸ› ï¸ Thiáº¿t láº­p SSH
      run: |
        mkdir -p ~/.ssh
        install -m 600 -D /dev/null ~/.ssh/id_rsa
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SSH_HOST }} > ~/.ssh/known_hosts

    - name: ğŸš€ Káº¿t ná»‘i SSH vÃ  cháº¡y lá»‡nh
      run: |
        echo "ğŸ“¡ Äang káº¿t ná»‘i SSH Ä‘áº¿n ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}"
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          echo "âœ… Káº¿t ná»‘i SSH thÃ nh cÃ´ng!"

          echo "ğŸ“‚ Di chuyá»ƒn vÃ o thÆ° má»¥c: ${{ secrets.WORK_DIR }}"
          cd ${{ secrets.WORK_DIR }} || { echo "âŒ KhÃ´ng tÃ¬m tháº¥y thÆ° má»¥c lÃ m viá»‡c!"; exit 1; }

          echo "ğŸ“Œ Checkout branch: ${{ secrets.MAIN_BRANCH }}"
          git checkout ${{ secrets.MAIN_BRANCH }} || { echo "âŒ Checkout tháº¥t báº¡i!"; exit 1; }

          echo "ğŸ“¥ Pull code..."
          git pull || { echo "âŒ Pull code tháº¥t báº¡i!"; exit 1; }

          echo "ğŸš€ Cháº¡y script deploy.sh..."
          chmod +x ./deploy.sh
          ./deploy.sh || { echo "âŒ Script deploy.sh lá»—i!"; exit 1; }

          echo "âœ… Deploy thÃ nh cÃ´ng!"
        EOF
